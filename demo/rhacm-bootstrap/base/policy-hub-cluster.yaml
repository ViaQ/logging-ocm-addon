apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  name: policy-hub-logging
spec:
  disabled: false
  policy-templates:
  - extraDependencies:
    - apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: ConfigurationPolicy
      name: redhat-loki-operator
    objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: redhat-openshift-logging
      spec:
        remediationAction: enforce
        severity: high
        pruneObjectBehavior: DeleteAll
        object-templates:
        # Install cert-manager to provide TLS secrets
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Namespace
            metadata:
              name: cert-manager-operator        
        - complianceType: musthave
          objectDefinition:
            apiVersion: operators.coreos.com/v1
            kind: OperatorGroup
            metadata:
              annotations:
                olm.providedAPIs: CertManager.v1alpha1.operator.openshift.io,Certificate.v1.cert-manager.io,CertificateRequest.v1.cert-manager.io,Challenge.v1.acme.cert-manager.io,ClusterIssuer.v1.cert-manager.io,Issuer.v1.cert-manager.io,Order.v1.acme.cert-manager.io
              name: cert-manager-operator
              namespace: cert-manager-operator
            spec:
              targetNamespaces:
              - cert-manager-operator
              upgradeStrategy: Default
        - complianceType: musthave
          objectDefinition:
            apiVersion: operators.coreos.com/v1alpha1
            kind: Subscription
            metadata:
              labels:
                operators.coreos.com/openshift-cert-manager-operator.cert-manager-operator: ""
              name: openshift-cert-manager-operator
              namespace: cert-manager-operator
            spec:
              channel: stable-v1
              installPlanApproval: Automatic
              name: openshift-cert-manager-operator
              source: redhat-operators
              sourceNamespace: openshift-marketplace
        # End of cert-manager installation
        - complianceType: musthave
          objectDefinition:
            apiVersion: operators.coreos.com/v1
            kind: OperatorGroup
            metadata:
              annotations:
                olm.providedAPIs: ClusterLogForwarder.v1.logging.openshift.io,ClusterLogging.v1.logging.openshift.io
              name: openshift-logging
              namespace: openshift-logging
            spec:
              targetNamespaces:
              - openshift-logging
              upgradeStrategy: Default
        - complianceType: musthave
          objectDefinition:
            apiVersion: operators.coreos.com/v1alpha1
            kind: Subscription
            metadata:
              labels:
                operators.coreos.com/cluster-logging.openshift-logging: ''
              name: cluster-logging
              namespace: openshift-logging
            spec:
              channel: stable
              installPlanApproval: Automatic
              name: cluster-logging
              source: redhat-operators
              sourceNamespace: openshift-marketplace
        - complianceType: musthave
          objectDefinition:
            apiVersion: logging.openshift.io/v1
            kind: ClusterLogging
            metadata:
              name: instance
              namespace: openshift-logging
            spec:
              collection:
                type: vector
              managementState: Managed
        - complianceType: musthave
          objectDefinition:
            apiVersion: logging.openshift.io/v1
            kind: ClusterLogForwarder
            metadata:
              name: instance
              namespace: openshift-logging
            spec:
              outputs:
               - loki:
                   labelKeys:
                   - log_type
                   - kubernetes.namespace_name
                   - kubernetes.pod_name
                   - openshift.cluster_id
                 name: hub-infra-to-hub
                 type: "loki"
                # TODO (JoaoBraveCoding) fix
                #  url: 'http://lokistack-hub.openshift-logging.svc:8080/api/logs/v1/{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantHubName" }}'
                 url: 'https://lokistack-hub-gateway-http.openshift-logging.svc:8080/api/logs/v1/local-cluster'
                 secret:
                    name: mtls-spoke-hub
              pipelines:
               - name: send-infra-logs-to-hub
                 inputRefs:
                 - infrastructure
                 outputRefs:
                 - hub-infra-to-hub
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: redhat-loki-operator
      spec:
        remediationAction: enforce
        severity: high
        pruneObjectBehavior: DeleteAll
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: operators.coreos.com/v1
            kind: OperatorGroup
            metadata:
              annotations:
                olm.providedAPIs: AlertingRule.v1.loki.grafana.com,LokiStack.v1.loki.grafana.com,RecordingRule.v1.loki.grafana.com,RulerConfig.v1.loki.grafana.com
              name: openshift-operators-redhat
              namespace: openshift-operators-redhat
            spec:
              upgradeStrategy: Default
        # Commented out until 5.8 is released which contains mTLS support
        # - complianceType: musthave
        #   objectDefinition:
        #     apiVersion: operators.coreos.com/v1alpha1
        #     kind: Subscription
        #     metadata:
        #       labels:
        #         operators.coreos.com/loki-operator.openshift-operators-redhat: ''
        #       name: loki-operator
        #       namespace: openshift-operators-redhat
        #     spec:
        #       channel: stable
        #       installPlanApproval: Automatic
        #       name: loki-operator
        #       source: redhat-operators
        #       sourceNamespace: openshift-marketplace
  - extraDependencies:
    - apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: ConfigurationPolicy
      name: redhat-loki-operator
    objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: lokistack-hub
      spec:
        remediationAction: enforce
        severity: high
        pruneObjectBehavior: DeleteAll
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: loki.grafana.com/v1
            kind: LokiStack
            metadata:
              name: lokistack-hub
              namespace: openshift-logging
            spec:
              # managedState: Unmanaged
              size: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "lokiStackSize" }}'
              storage:
                secret:
                  name: hub-lokistack-s3-credentials
                  type: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "lokiStackStorageType" }}'
              storageClassName: gp3-csi
              # TODO (JoaoBraveCoding) fix
              # storageClassName: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "lokiStackStorageClass" }}'
              tenants:
                authentication:
                - mTLS:
                    ca:
                      caName: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantHubName" }}' 
                  tenantId: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantHubID" }}'
                  tenantName: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantHubName" }}'
                - mTLS:
                    ca:
                      caName: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantSpokeName" }}' 
                  tenantId: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantSpokeID" }}'
                  tenantName: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantSpokeName" }}'
                authorization:
                  roleBindings:
                  - name: write-logs
                    roles:
                    - write-logs
                    subjects:
                    - kind: user
                      name: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "usernameWriteLogs" }}'
                  - name: read-logs
                    roles:
                    - read-logs
                    subjects:
                    - kind: user
                      name: '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "usernameReadLogs" }}'
                  roles:
                  - name: read-logs
                    permissions:
                    - read
                    resources:
                    - logs
                    tenants:
                    - '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantHubName" }}'
                    - '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantSpokeName" }}'
                  - name: write-logs
                    permissions:
                    - write
                    resources:
                    - logs
                    tenants:
                    - '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantHubName" }}'
                    - '{{ fromConfigMap "openshift-logging" "hub-log-storage-config" "tenantSpokeName" }}'
                mode: static
